{"ast":null,"code":"import _regeneratorRuntime from \"/var/www/crm_template/packages/oobook/crm-base/vue/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _createForOfIteratorHelper from \"/var/www/crm_template/packages/oobook/crm-base/vue/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";\nimport _asyncToGenerator from \"/var/www/crm_template/packages/oobook/crm-base/vue/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport \"core-js/modules/es.symbol.js\";\nimport \"core-js/modules/es.symbol.description.js\";\nimport \"core-js/modules/es.object.to-string.js\";\nimport \"core-js/modules/es.array.for-each.js\";\nimport \"core-js/modules/web.dom-collections.for-each.js\";\nimport \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.array.some.js\";\nimport \"core-js/modules/es.array.filter.js\";\nimport \"core-js/modules/es.array.find.js\";\n// Utilities\nimport { computed, inject, provide, ref, toRef, watch } from 'vue';\nimport { useProxiedModel } from \"./proxiedModel.mjs\";\nimport { consoleWarn, propsFactory } from \"../util/index.mjs\"; // Types\nexport var FormKey = Symbol[\"for\"]('vuetify:form');\nexport var makeFormProps = propsFactory({\n  disabled: Boolean,\n  fastFail: Boolean,\n  readonly: Boolean,\n  modelValue: {\n    type: Boolean,\n    \"default\": null\n  },\n  validateOn: {\n    type: String,\n    \"default\": 'input'\n  }\n}, 'form');\nexport function createForm(props) {\n  var model = useProxiedModel(props, 'modelValue');\n  var isDisabled = computed(function () {\n    return props.disabled;\n  });\n  var isReadonly = computed(function () {\n    return props.readonly;\n  });\n  var isValidating = ref(false);\n  var items = ref([]);\n  var errors = ref([]);\n  function validate() {\n    return _validate.apply(this, arguments);\n  }\n  function _validate() {\n    _validate = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n      var results, valid, _iterator2, _step2, item, itemErrorMessages;\n      return _regeneratorRuntime().wrap(function _callee$(_context) {\n        while (1) switch (_context.prev = _context.next) {\n          case 0:\n            results = [];\n            valid = true;\n            errors.value = [];\n            isValidating.value = true;\n            _iterator2 = _createForOfIteratorHelper(items.value);\n            _context.prev = 5;\n            _iterator2.s();\n          case 7:\n            if ((_step2 = _iterator2.n()).done) {\n              _context.next = 17;\n              break;\n            }\n            item = _step2.value;\n            _context.next = 11;\n            return item.validate();\n          case 11:\n            itemErrorMessages = _context.sent;\n            if (itemErrorMessages.length > 0) {\n              valid = false;\n              results.push({\n                id: item.id,\n                errorMessages: itemErrorMessages\n              });\n            }\n            if (!(!valid && props.fastFail)) {\n              _context.next = 15;\n              break;\n            }\n            return _context.abrupt(\"break\", 17);\n          case 15:\n            _context.next = 7;\n            break;\n          case 17:\n            _context.next = 22;\n            break;\n          case 19:\n            _context.prev = 19;\n            _context.t0 = _context[\"catch\"](5);\n            _iterator2.e(_context.t0);\n          case 22:\n            _context.prev = 22;\n            _iterator2.f();\n            return _context.finish(22);\n          case 25:\n            errors.value = results;\n            isValidating.value = false;\n            return _context.abrupt(\"return\", {\n              valid: valid,\n              errors: errors.value\n            });\n          case 28:\n          case \"end\":\n            return _context.stop();\n        }\n      }, _callee, null, [[5, 19, 22, 25]]);\n    }));\n    return _validate.apply(this, arguments);\n  }\n  function reset() {\n    items.value.forEach(function (item) {\n      return item.reset();\n    });\n    model.value = null;\n  }\n  function resetValidation() {\n    items.value.forEach(function (item) {\n      return item.resetValidation();\n    });\n    errors.value = [];\n    model.value = null;\n  }\n  watch(items, function () {\n    var valid = 0;\n    var invalid = 0;\n    var results = [];\n    var _iterator = _createForOfIteratorHelper(items.value),\n      _step;\n    try {\n      for (_iterator.s(); !(_step = _iterator.n()).done;) {\n        var item = _step.value;\n        if (item.isValid === false) {\n          invalid++;\n          results.push({\n            id: item.id,\n            errorMessages: item.errorMessages\n          });\n        } else if (item.isValid === true) valid++;\n      }\n    } catch (err) {\n      _iterator.e(err);\n    } finally {\n      _iterator.f();\n    }\n    errors.value = results;\n    model.value = invalid > 0 ? false : valid === items.value.length ? true : null;\n  }, {\n    deep: true\n  });\n  provide(FormKey, {\n    register: function register(_ref) {\n      var id = _ref.id,\n        validate = _ref.validate,\n        reset = _ref.reset,\n        resetValidation = _ref.resetValidation;\n      if (items.value.some(function (item) {\n        return item.id === id;\n      })) {\n        consoleWarn(\"Duplicate input name \\\"\".concat(id, \"\\\"\"));\n      }\n      items.value.push({\n        id: id,\n        validate: validate,\n        reset: reset,\n        resetValidation: resetValidation,\n        isValid: null,\n        errorMessages: []\n      });\n    },\n    unregister: function unregister(id) {\n      items.value = items.value.filter(function (item) {\n        return item.id !== id;\n      });\n    },\n    update: function update(id, isValid, errorMessages) {\n      var found = items.value.find(function (item) {\n        return item.id === id;\n      });\n      if (!found) return;\n      found.isValid = isValid;\n      found.errorMessages = errorMessages;\n    },\n    isDisabled: isDisabled,\n    isReadonly: isReadonly,\n    isValidating: isValidating,\n    items: items,\n    validateOn: toRef(props, 'validateOn')\n  });\n  return {\n    errors: errors,\n    isDisabled: isDisabled,\n    isReadonly: isReadonly,\n    isValidating: isValidating,\n    items: items,\n    validate: validate,\n    reset: reset,\n    resetValidation: resetValidation\n  };\n}\nexport function useForm() {\n  return inject(FormKey, null);\n}","map":{"version":3,"names":["computed","inject","provide","ref","toRef","watch","useProxiedModel","consoleWarn","propsFactory","FormKey","Symbol","makeFormProps","disabled","Boolean","fastFail","readonly","modelValue","type","validateOn","String","createForm","props","model","isDisabled","isReadonly","isValidating","items","errors","validate","_validate","apply","arguments","_asyncToGenerator","_regeneratorRuntime","mark","_callee","results","valid","_iterator2","_step2","item","itemErrorMessages","wrap","_callee$","_context","prev","next","value","_createForOfIteratorHelper","s","n","done","sent","length","push","id","errorMessages","abrupt","t0","e","f","finish","stop","reset","forEach","resetValidation","invalid","_iterator","_step","isValid","err","deep","register","_ref","some","concat","unregister","filter","update","found","find","useForm"],"sources":["../../src/composables/form.ts"],"sourcesContent":["// Utilities\nimport { computed, inject, provide, ref, toRef, watch } from 'vue'\nimport { useProxiedModel } from '@/composables/proxiedModel'\nimport { consoleWarn, propsFactory } from '@/util'\n\n// Types\nimport type { ComputedRef, InjectionKey, PropType, Ref } from 'vue'\nimport type { ValidationProps } from './validation'\n\nexport interface FormProvide {\n  register: (item: {\n    id: number | string\n    validate: () => Promise<string[]>\n    reset: () => void\n    resetValidation: () => void\n  }) => void\n  unregister: (id: number | string) => void\n  update: (id: number | string, isValid: boolean | null, errorMessages: string[]) => void\n  items: Ref<FormField[]>\n  isDisabled: ComputedRef<boolean>\n  isReadonly: ComputedRef<boolean>\n  isValidating: Ref<boolean>\n  validateOn: Ref<FormProps['validateOn']>\n}\n\ninterface FormField {\n  id: number | string\n  validate: () => Promise<string[]>\n  reset: () => void\n  resetValidation: () => void\n  isValid: boolean | null\n  errorMessages: string[]\n}\n\ninterface FieldValidationResult {\n  id: number | string\n  errorMessages: string[]\n}\n\ninterface FormValidationResult {\n  valid: boolean\n  errors: FieldValidationResult[]\n}\n\nexport interface SubmitEventPromise extends SubmitEvent, Promise<FormValidationResult> {}\n\nexport const FormKey: InjectionKey<FormProvide> = Symbol.for('vuetify:form')\n\nexport interface FormProps {\n  disabled: boolean\n  fastFail: boolean\n  readonly: boolean\n  modelValue: boolean | null\n  'onUpdate:modelValue': ((val: boolean | null) => void) | undefined\n  validateOn: ValidationProps['validateOn']\n}\n\nexport const makeFormProps = propsFactory({\n  disabled: Boolean,\n  fastFail: Boolean,\n  readonly: Boolean,\n  modelValue: {\n    type: Boolean as PropType<boolean | null>,\n    default: null,\n  },\n  validateOn: {\n    type: String as PropType<FormProps['validateOn']>,\n    default: 'input',\n  },\n}, 'form')\n\nexport function createForm (props: FormProps) {\n  const model = useProxiedModel(props, 'modelValue')\n\n  const isDisabled = computed(() => props.disabled)\n  const isReadonly = computed(() => props.readonly)\n  const isValidating = ref(false)\n  const items = ref<FormField[]>([])\n  const errors = ref<FieldValidationResult[]>([])\n\n  async function validate () {\n    const results = []\n    let valid = true\n\n    errors.value = []\n    isValidating.value = true\n\n    for (const item of items.value) {\n      const itemErrorMessages = await item.validate()\n\n      if (itemErrorMessages.length > 0) {\n        valid = false\n\n        results.push({\n          id: item.id,\n          errorMessages: itemErrorMessages,\n        })\n      }\n\n      if (!valid && props.fastFail) break\n    }\n\n    errors.value = results\n    isValidating.value = false\n\n    return { valid, errors: errors.value }\n  }\n\n  function reset () {\n    items.value.forEach(item => item.reset())\n    model.value = null\n  }\n\n  function resetValidation () {\n    items.value.forEach(item => item.resetValidation())\n    errors.value = []\n    model.value = null\n  }\n\n  watch(items, () => {\n    let valid = 0\n    let invalid = 0\n    const results = []\n\n    for (const item of items.value) {\n      if (item.isValid === false) {\n        invalid++\n        results.push({\n          id: item.id,\n          errorMessages: item.errorMessages,\n        })\n      } else if (item.isValid === true) valid++\n    }\n\n    errors.value = results\n    model.value =\n      invalid > 0 ? false\n      : valid === items.value.length ? true\n      : null\n  }, { deep: true })\n\n  provide(FormKey, {\n    register: ({ id, validate, reset, resetValidation }) => {\n      if (items.value.some(item => item.id === id)) {\n        consoleWarn(`Duplicate input name \"${id}\"`)\n      }\n\n      items.value.push({\n        id,\n        validate,\n        reset,\n        resetValidation,\n        isValid: null,\n        errorMessages: [],\n      })\n    },\n    unregister: id => {\n      items.value = items.value.filter(item => {\n        return item.id !== id\n      })\n    },\n    update: (id, isValid, errorMessages) => {\n      const found = items.value.find(item => item.id === id)\n\n      if (!found) return\n\n      found.isValid = isValid\n      found.errorMessages = errorMessages\n    },\n    isDisabled,\n    isReadonly,\n    isValidating,\n    items,\n    validateOn: toRef(props, 'validateOn'),\n  })\n\n  return {\n    errors,\n    isDisabled,\n    isReadonly,\n    isValidating,\n    items,\n    validate,\n    reset,\n    resetValidation,\n  }\n}\n\nexport function useForm () {\n  return inject(FormKey, null)\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}